<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ton Racing ‚Äì 3D –ì–æ–Ω–∫–∞</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Racing Sans One', 'Segoe UI', system-ui, sans-serif;
            background: #0c0c0c;
            color: white;
            overflow: hidden;
        }

        #canvas-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 1;
        }

        #ui-container {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 10;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            padding: 20px;
        }

        /* –í–µ—Ä—Ö–Ω—è—è —à–∞–ø–∫–∞ */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: rgba(0,0,0,0.7);
            border: 2px solid #e10600;
            padding: 12px 20px;
            clip-path: polygon(10px 0, 100% 0, 100% calc(100% - 10px), calc(100% - 10px) 100%, 0 100%, 0 10px);
            pointer-events: auto;
            backdrop-filter: blur(5px);
            max-width: 1200px;
            margin: 0 auto;
            width: 100%;
            box-shadow: 0 0 30px rgba(225,6,0,0.5);
        }

        .back-to-menu {
            color: white;
            text-decoration: none;
            font-weight: bold;
            font-size: 16px;
            padding: 8px 16px;
            border: 2px solid #e10600;
            clip-path: polygon(5px 0, 100% 0, 100% calc(100% - 5px), calc(100% - 5px) 100%, 0 100%, 0 5px);
            transition: 0.2s;
        }

        .back-to-menu:active {
            background: #e10600;
            color: black;
        }

        .coins-header {
            background: linear-gradient(135deg, #e10600, #ff4d4d);
            padding: 8px 20px;
            font-weight: bold;
            font-size: 18px;
            clip-path: polygon(10px 0, 100% 0, 100% 100%, 0 100%, 0 10px);
        }

        /* –ù–∞–≤–∏–≥–∞—Ü–∏–æ–Ω–Ω–æ–µ –º–µ–Ω—é */
        .nav-menu {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin: 10px auto;
            pointer-events: auto;
            max-width: 1200px;
        }

        .nav-item {
            width: 50px;
            height: 50px;
            background: rgba(0,0,0,0.8);
            border: 2px solid #e10600;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            text-decoration: none;
            color: white;
            clip-path: polygon(5px 0, 100% 0, 100% calc(100% - 5px), calc(100% - 5px) 100%, 0 100%, 0 5px);
            transition: 0.2s;
        }

        .nav-item:hover {
            background: #e10600;
            color: black;
        }

        .nav-item.active {
            background: #e10600;
            color: black;
            box-shadow: 0 0 20px #e10600;
        }

        /* –ü–∞–Ω–µ–ª—å –≥–æ–Ω–∫–∏ */
        .race-panel {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 100%;
            max-width: 800px;
            pointer-events: none;
            z-index: 20;
        }

        .race-status {
            text-align: center;
            font-size: 32px;
            color: #e10600;
            text-transform: uppercase;
            letter-spacing: 4px;
            text-shadow: 0 0 20px #e10600;
            margin-bottom: 20px;
            animation: blink 1s infinite;
        }

        @keyframes blink {
            50% { opacity: 0.5; }
        }

        /* –ü—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä –≥–æ–Ω–∫–∏ */
        .progress-container {
            background: rgba(0,0,0,0.6);
            border: 2px solid #e10600;
            padding: 15px;
            clip-path: polygon(10px 0, 100% 0, 100% calc(100% - 10px), calc(100% - 10px) 100%, 0 100%, 0 10px);
            backdrop-filter: blur(5px);
            margin-bottom: 20px;
        }

        .progress-bar {
            height: 20px;
            background: linear-gradient(90deg, #e10600, #ff4d4d);
            width: 0%;
            transition: width 0.1s linear;
            clip-path: polygon(5px 0, 100% 0, 100% calc(100% - 5px), calc(100% - 5px) 100%, 0 100%, 0 5px);
        }

        .progress-labels {
            display: flex;
            justify-content: space-between;
            margin-top: 5px;
            color: #e10600;
            font-size: 14px;
        }

        /* –•–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏ –≥–æ–Ω–∫–∏ */
        .race-stats {
            display: flex;
            gap: 20px;
            justify-content: center;
            flex-wrap: wrap;
            margin-bottom: 20px;
        }

        .stat-card {
            background: rgba(0,0,0,0.6);
            border: 2px solid #e10600;
            padding: 15px 25px;
            clip-path: polygon(5px 0, 100% 0, 100% calc(100% - 5px), calc(100% - 5px) 100%, 0 100%, 0 5px);
            backdrop-filter: blur(5px);
            text-align: center;
            min-width: 120px;
        }

        .stat-label {
            color: #e10600;
            font-size: 14px;
            text-transform: uppercase;
            margin-bottom: 5px;
        }

        .stat-value {
            font-size: 24px;
            font-weight: bold;
            color: white;
        }

        /* –ö–Ω–æ–ø–∫–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è */
        .race-controls {
            display: flex;
            gap: 20px;
            justify-content: center;
            pointer-events: auto;
        }

        .race-btn {
            background: rgba(0,0,0,0.7);
            border: 2px solid #e10600;
            color: white;
            font-size: 20px;
            font-weight: bold;
            padding: 15px 40px;
            cursor: pointer;
            transition: 0.3s;
            text-transform: uppercase;
            letter-spacing: 2px;
            clip-path: polygon(10px 0, 100% 0, 100% calc(100% - 10px), calc(100% - 10px) 100%, 0 100%, 0 10px);
            backdrop-filter: blur(5px);
            min-width: 150px;
        }

        .race-btn:hover:not(:disabled) {
            background: #e10600;
            color: black;
            transform: scale(1.05);
            box-shadow: 0 0 40px #e10600;
        }

        .race-btn:disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }

        .race-btn.stop {
            border-color: #f00;
        }
        .race-btn.stop:hover:not(:disabled) {
            background: #f00;
        }

        /* –†–µ–∑—É–ª—å—Ç–∞—Ç –≥–æ–Ω–∫–∏ */
        .race-result {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0,0,0,0.9);
            border: 3px solid;
            padding: 30px 50px;
            text-align: center;
            z-index: 100;
            backdrop-filter: blur(10px);
            clip-path: polygon(20px 0, 100% 0, 100% calc(100% - 20px), calc(100% - 20px) 100%, 0 100%, 0 20px);
            display: none;
        }

        .result-win {
            border-color: #0f0;
            box-shadow: 0 0 50px #0f0;
        }

        .result-lose {
            border-color: #f00;
            box-shadow: 0 0 50px #f00;
        }

        .result-title {
            font-size: 48px;
            font-weight: bold;
            margin-bottom: 20px;
        }

        .result-win .result-title { color: #0f0; text-shadow: 0 0 30px #0f0; }
        .result-lose .result-title { color: #f00; text-shadow: 0 0 30px #f00; }

        .result-reward {
            font-size: 32px;
            color: #fff;
            margin-bottom: 20px;
        }

        .result-btn {
            background: transparent;
            border: 2px solid #e10600;
            color: white;
            padding: 10px 30px;
            font-size: 18px;
            cursor: pointer;
            margin-top: 20px;
            clip-path: polygon(5px 0, 100% 0, 100% calc(100% - 5px), calc(100% - 5px) 100%, 0 100%, 0 5px);
        }

        .result-btn:hover {
            background: #e10600;
            color: black;
        }

        /* –°—É–Ω–¥—É–∫ */
        .chest-container {
            position: absolute;
            top: 30%;
            left: 50%;
            transform: translateX(-50%);
            text-align: center;
            z-index: 100;
            pointer-events: auto;
            animation: chestFloat 1s infinite alternate;
        }

        .chest {
            font-size: 100px;
            cursor: pointer;
            filter: drop-shadow(0 0 30px gold);
        }

        .chest-message {
            color: gold;
            font-size: 24px;
            font-weight: bold;
            text-shadow: 0 0 20px gold;
        }

        @keyframes chestFloat {
            from { transform: translateX(-50%) translateY(0); }
            to { transform: translateX(-50%) translateY(-20px); }
        }

        /* –¢–µ–ª–µ–º–µ—Ç—Ä–∏—è */
        .f1-telemetry {
            position: fixed;
            bottom: 20px;
            right: 20px;
            display: flex;
            gap: 8px;
            background: rgba(0,0,0,0.8);
            border: 1px solid #e10600;
            padding: 10px 20px;
            clip-path: polygon(10px 0, 100% 0, 100% 100%, 0 100%, 0 10px);
            z-index: 100;
            pointer-events: none;
        }

        .telemetry-dot {
            width: 16px;
            height: 16px;
            transform: rotate(45deg);
            box-shadow: 0 0 10px currentColor;
        }

        .telemetry-dot.red { background: #ff4444; }
        .telemetry-dot.green { background: #44ff44; }
        .telemetry-dot.blue { background: #4444ff; }
        .telemetry-dot.yellow { background: #ffff44; }
        .telemetry-dot.orange { background: #ff8844; }
        .telemetry-dot.purple { background: #ff44ff; }

        /* –ö–Ω–æ–ø–∫–∞ –≤—ã—Ö–æ–¥–∞ */
        .exit-btn {
            position: fixed;
            bottom: 20px;
            left: 20px;
            background: transparent;
            border: 2px solid #e10600;
            color: #e10600;
            padding: 10px 20px;
            font-weight: bold;
            cursor: pointer;
            transition: 0.3s;
            text-decoration: none;
            text-transform: uppercase;
            letter-spacing: 2px;
            backdrop-filter: blur(10px);
            font-size: 14px;
            z-index: 100;
            clip-path: polygon(0 0, 100% 0, 100% calc(100% - 5px), calc(100% - 5px) 100%, 0 100%, 0 5px);
            pointer-events: auto;
        }

        .exit-btn:hover {
            background: #e10600;
            color: #000;
        }

        .notification {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: #e10600;
            color: white;
            padding: 12px 24px;
            font-weight: bold;
            z-index: 3000;
            display: none;
            font-size: 14px;
            white-space: nowrap;
            box-shadow: 0 0 30px #e10600;
            clip-path: polygon(0 0, 100% 0, 100% calc(100% - 5px), calc(100% - 5px) 100%, 0 100%, 0 5px);
            pointer-events: none;
        }

        .notification.show {
            display: block;
            animation: slideIn 0.3s;
        }
        @keyframes slideIn {
            from { transform: translateX(-50%) translateY(-100%); }
            to { transform: translateX(-50%) translateY(0); }
        }
    </style>
</head>
<body>
    <!-- 3D —Å—Ü–µ–Ω–∞ -->
    <div id="canvas-container"></div>

    <!-- –ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å -->
    <div id="ui-container">
        <div>
            <div class="header">
                <a href="index.html" class="back-to-menu">‚Üê –ú–ï–ù–Æ</a>
                <div class="coins-header" id="coinsDisplay">1000 ü™ô</div>
            </div>
            <div class="nav-menu">
                <a href="garage.html" class="nav-item">üîß</a>
                <a href="race.html" class="nav-item active">üèÅ</a>
                <a href="shop.html" class="nav-item">üõí</a>
                <a href="rating.html" class="nav-item">üìä</a>
            </div>
        </div>

        <!-- –ü–∞–Ω–µ–ª—å –≥–æ–Ω–∫–∏ -->
        <div class="race-panel">
            <div class="race-status" id="raceStatus">–ì–û–¢–û–í –ö –ì–û–ù–ö–ï</div>
            
            <div class="progress-container">
                <div class="progress-bar" id="progressBar" style="width: 0%"></div>
                <div class="progress-labels">
                    <span>–°–¢–ê–†–¢</span>
                    <span>–§–ò–ù–ò–®</span>
                </div>
            </div>

            <div class="race-stats">
                <div class="stat-card">
                    <div class="stat-label">–¢–í–û–Ø –°–ö–û–†–û–°–¢–¨</div>
                    <div class="stat-value" id="playerSpeed">0</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">–°–ö–û–†–û–°–¢–¨ –ö–ò–†–Æ–•–ò</div>
                    <div class="stat-value" id="enemySpeed">0</div>
                </div>
            </div>

            <div class="race-controls">
                <button class="race-btn start" id="startRaceBtn" onclick="startRace()">üèÅ –°–¢–ê–†–¢</button>
                <button class="race-btn stop" id="stopRaceBtn" onclick="stopRace()" disabled>‚èπ –°–¢–û–ü</button>
            </div>
        </div>

        <!-- –†–µ–∑—É–ª—å—Ç–∞—Ç -->
        <div id="raceResult" class="race-result">
            <div class="result-title" id="resultTitle"></div>
            <div class="result-reward" id="resultReward"></div>
            <button class="result-btn" onclick="closeResult()">–û–ö</button>
        </div>
    </div>

    <!-- –¢–µ–ª–µ–º–µ—Ç—Ä–∏—è -->
    <div class="f1-telemetry">
        <div class="telemetry-dot red" title="–°–∫–æ—Ä–æ—Å—Ç—å"></div>
        <div class="telemetry-dot green" title="–°—Ü–µ–ø–ª–µ–Ω–∏–µ"></div>
        <div class="telemetry-dot blue" title="–†–∞–∑–≥–æ–Ω"></div>
        <div class="telemetry-dot yellow" title="–ú–∞–∫—Å —Å–∫–æ—Ä–æ—Å—Ç—å"></div>
        <div class="telemetry-dot orange" title="–†—ã–≤–æ–∫"></div>
        <div class="telemetry-dot purple" title="–ú–æ—â–Ω–æ—Å—Ç—å"></div>
    </div>

    <!-- –ö–Ω–æ–ø–∫–∞ –≤—ã—Ö–æ–¥–∞ -->
    <a href="#" class="exit-btn" onclick="window.Telegram?.WebApp?.close()">‚úñ –í–´–•–û–î</a>

    <!-- –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ -->
    <div id="notification" class="notification"></div>

    <!-- –ü–æ–¥–∫–ª—é—á–∞–µ–º Three.js -->
    <script type="importmap">
        {
            "imports": {
                "three": "https://unpkg.com/three@0.128.0/build/three.module.js",
                "three/addons/": "https://unpkg.com/three@0.128.0/examples/jsm/"
            }
        }
    </script>

    <script type="module">
        import * as THREE from 'three';
        import { OrbitControls } from 'https://unpkg.com/three@0.128.0/examples/jsm/controls/OrbitControls.js';
        import { OBJLoader } from 'https://unpkg.com/three@0.128.0/examples/jsm/loaders/OBJLoader.js';
        import { MTLLoader } from 'https://unpkg.com/three@0.128.0/examples/jsm/loaders/MTLLoader.js';

        // --- 3D –°–¶–ï–ù–ê ---
        const container = document.getElementById('canvas-container');
        const scene = new THREE.Scene();
        scene.background = new THREE.Color(0x0a0a14);

        const camera = new THREE.PerspectiveCamera(60, window.innerWidth / window.innerHeight, 0.1, 1000);
        camera.position.set(5, 2, 8);
        camera.lookAt(0, 0, 0);

        const renderer = new THREE.WebGLRenderer({ antialias: true, alpha: false });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.shadowMap.enabled = true;
        renderer.shadowMap.type = THREE.PCFSoftShadowMap;
        renderer.setPixelRatio(window.devicePixelRatio);
        container.appendChild(renderer.domElement);

        // --- –û—Å–≤–µ—â–µ–Ω–∏–µ ---
        const ambientLight = new THREE.AmbientLight(0x404060);
        scene.add(ambientLight);

        const dirLight = new THREE.DirectionalLight(0xffaa88, 1);
        dirLight.position.set(2, 5, 3);
        dirLight.castShadow = true;
        dirLight.shadow.mapSize.width = 1024;
        dirLight.shadow.mapSize.height = 1024;
        scene.add(dirLight);

        const backLight = new THREE.PointLight(0x3366ff, 0.8);
        backLight.position.set(-3, 2, -5);
        scene.add(backLight);

        const sideLight = new THREE.PointLight(0xff44aa, 0.5);
        sideLight.position.set(4, 1, 2);
        scene.add(sideLight);

        // --- –ü–æ–ª (—Ç—Ä–∞—Å—Å–∞) ---
        const trackLength = 30;
        const trackWidth = 4;

        // –ê—Å—Ñ–∞–ª—å—Ç
        const trackGeo = new THREE.PlaneGeometry(trackWidth, trackLength);
        const trackMat = new THREE.MeshStandardMaterial({ color: 0x222222, roughness: 0.7, metalness: 0.1 });
        const track = new THREE.Mesh(trackGeo, trackMat);
        track.rotation.x = -Math.PI / 2;
        track.position.set(0, -0.1, 0);
        track.receiveShadow = true;
        scene.add(track);

        // –†–∞–∑–º–µ—Ç–∫–∞
        const lineGeo = new THREE.PlaneGeometry(0.2, trackLength);
        const lineMat = new THREE.MeshStandardMaterial({ color: 0xffff00 });
        const centerLine = new THREE.Mesh(lineGeo, lineMat);
        centerLine.rotation.x = -Math.PI / 2;
        centerLine.position.set(0, -0.09, 0);
        centerLine.receiveShadow = true;
        scene.add(centerLine);

        // –ü–æ–ª–æ—Å—ã –ø–æ –±–æ–∫–∞–º
        const stripeGeo = new THREE.PlaneGeometry(0.3, trackLength);
        const stripeMat = new THREE.MeshStandardMaterial({ color: 0xffffff });
        
        const leftStripe = new THREE.Mesh(stripeGeo, stripeMat);
        leftStripe.rotation.x = -Math.PI / 2;
        leftStripe.position.set(-trackWidth/2 - 0.2, -0.09, 0);
        leftStripe.receiveShadow = true;
        scene.add(leftStripe);

        const rightStripe = new THREE.Mesh(stripeGeo, stripeMat);
        rightStripe.rotation.x = -Math.PI / 2;
        rightStripe.position.set(trackWidth/2 + 0.2, -0.09, 0);
        rightStripe.receiveShadow = true;
        scene.add(rightStripe);

        // –°—Ç–∞—Ä—Ç–æ–≤–∞—è –ª–∏–Ω–∏—è
        const startGeo = new THREE.PlaneGeometry(trackWidth, 0.5);
        const startMat = new THREE.MeshStandardMaterial({ color: 0xffffff });
        const startLine = new THREE.Mesh(startGeo, startMat);
        startLine.rotation.x = -Math.PI / 2;
        startLine.position.set(0, -0.08, -trackLength/2 + 1);
        startLine.receiveShadow = true;
        scene.add(startLine);

        // –§–∏–Ω–∏—à–Ω–∞—è –ª–∏–Ω–∏—è
        const finishGeo = new THREE.PlaneGeometry(trackWidth, 0.5);
        const finishMat = new THREE.MeshStandardMaterial({ color: 0xe10600 });
        const finishLine = new THREE.Mesh(finishGeo, finishMat);
        finishLine.rotation.x = -Math.PI / 2;
        finishLine.position.set(0, -0.08, trackLength/2 - 1);
        finishLine.receiveShadow = true;
        scene.add(finishLine);

        // –ó—Ä–∏—Ç–µ–ª–∏ (–ø—Ä–æ—Å—Ç—ã–µ –∫—É–±—ã)
        for (let i = -3; i <= 3; i+=2) {
            for (let j = -trackLength/2 + 2; j < trackLength/2 - 2; j+=3) {
                const boxGeo = new THREE.BoxGeometry(0.3, 0.5, 0.3);
                const boxMat = new THREE.MeshStandardMaterial({ color: 0xe10600 });
                const box = new THREE.Mesh(boxGeo, boxMat);
                box.position.set(i * 1.5, 0.25, j);
                box.castShadow = true;
                box.receiveShadow = true;
                scene.add(box);
            }
        }

        // --- –ì—Ä—É–ø–ø–∞ –¥–ª—è –º–∞—à–∏–Ω—ã –∏–≥—Ä–æ–∫–∞ ---
        const playerCarGroup = new THREE.Group();
        playerCarGroup.position.set(0, 0.2, -trackLength/2 + 2);
        scene.add(playerCarGroup);

        // --- –ì—Ä—É–ø–ø–∞ –¥–ª—è –º–∞—à–∏–Ω—ã –ø—Ä–æ—Ç–∏–≤–Ω–∏–∫–∞ ---
        const enemyCarGroup = new THREE.Group();
        enemyCarGroup.position.set(0, 0.2, -trackLength/2 + 1.5);
        scene.add(enemyCarGroup);

        // --- –ó–∞–≥—Ä—É–∑–∫–∞ –º–æ–¥–µ–ª–∏ –í–ê–ó-2107 ---
        const mtlLoader = new MTLLoader();
        const objLoader = new OBJLoader();

        mtlLoader.load(
            'models/VAZ2107.mtl',
            (materials) => {
                materials.preload();
                objLoader.setMaterials(materials);
                
                objLoader.load(
                    'models/VAZ2107.obj',
                    (object) => {
                        object.scale.set(0.01, 0.01, 0.01);
                        
                        // –ú–∞—à–∏–Ω–∞ –∏–≥—Ä–æ–∫–∞ (–∫—Ä–∞—Å–Ω–∞—è)
                        const playerCar = object.clone();
                        playerCar.traverse((child) => {
                            if (child.isMesh) {
                                child.castShadow = true;
                                child.receiveShadow = true;
                                if (child.material) {
                                    if (Array.isArray(child.material)) {
                                        child.material.forEach(mat => mat.color.setHex(0xff4444));
                                    } else {
                                        child.material.color.setHex(0xff4444);
                                    }
                                }
                            }
                        });
                        playerCarGroup.add(playerCar);

                        // –ú–∞—à–∏–Ω–∞ –ø—Ä–æ—Ç–∏–≤–Ω–∏–∫–∞ (—Å–∏–Ω—è—è)
                        const enemyCar = object.clone();
                        enemyCar.traverse((child) => {
                            if (child.isMesh) {
                                child.castShadow = true;
                                child.receiveShadow = true;
                                if (child.material) {
                                    if (Array.isArray(child.material)) {
                                        child.material.forEach(mat => mat.color.setHex(0x4444ff));
                                    } else {
                                        child.material.color.setHex(0x4444ff);
                                    }
                                }
                            }
                        });
                        enemyCarGroup.add(enemyCar);
                    },
                    (xhr) => {
                        console.log((xhr.loaded / xhr.total * 100) + '% –∑–∞–≥—Ä—É–∂–µ–Ω–æ');
                    },
                    (error) => {
                        console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ OBJ:', error);
                    }
                );
            },
            undefined,
            (error) => {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ MTL:', error);
            }
        );

        // --- –ö–∞–º–µ—Ä–∞ (–≤–∏–¥ —Å–∑–∞–¥–∏) ---
        const controls = new OrbitControls(camera, renderer.domElement);
        controls.enableDamping = true;
        controls.dampingFactor = 0.05;
        controls.autoRotate = false;
        controls.enableZoom = true;
        controls.enablePan = false;
        controls.maxPolarAngle = Math.PI / 2.2;
        controls.target.set(0, 0.5, 0);

        // --- –ê–Ω–∏–º–∞—Ü–∏—è ---
        function animate() {
            requestAnimationFrame(animate);
            controls.update();
            renderer.render(scene, camera);
        }
        animate();

        // --- –†–µ—Å–∞–π–∑ ---
        window.addEventListener('resize', () => {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        });

        // --- –õ–û–ì–ò–ö–ê –ì–û–ù–ö–ò ---
        const COINS_KEY = 'playerCoins';
        const ACTIVE_CUBES_KEY = 'activeCubes';
        const INVENTORY_KEY = 'playerInventory';

        let raceInterval = null;
        let raceActive = false;
        let playerProgress = 0;
        let enemyProgress = 0;
        let playerSpeed = 0;
        let enemySpeed = 0;
        let playerStats = null;
        let enemyStats = null;

        // –•–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏ –∫—É–±–æ–≤
        const cubeStats = {
            red:    { speed: 30, grip: 0, accel: 0, maxSpeed: 0, luck: 0, power: 0 },
            green:  { speed: 0, grip: 20, accel: 0, maxSpeed: 0, luck: 0, power: 0 },
            blue:   { speed: 0, grip: 0, accel: 0, maxSpeed: 30, luck: 0, power: 0 },
            yellow: { speed: 0, grip: 0, accel: 0, maxSpeed: 0, luck: 0.2, power: 0 },
            orange: { speed: 0, grip: 0, accel: 3, maxSpeed: 0, luck: 0, power: 0 },
            purple: { speed: 0, grip: 0, accel: 0, maxSpeed: 0, luck: 0, power: 20 }
        };

        // –ó–∞–≥—Ä—É–∑–∫–∞ —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫ –∏–∑ –∞–∫—Ç–∏–≤–Ω—ã—Ö –∫—É–±–æ–≤
        function loadPlayerStats() {
            const activeCubes = JSON.parse(localStorage.getItem(ACTIVE_CUBES_KEY)) || [];
            
            let speed = 50;
            let grip = 50;
            let accel = 5;
            let maxSpeed = 100;
            let luck = 0;
            let power = 100;

            activeCubes.forEach((cube, index) => {
                if (cube) {
                    const color = cube.color;
                    const stats = cubeStats[color];
                    if (stats) {
                        speed += stats.speed;
                        grip += stats.grip;
                        accel += stats.accel;
                        maxSpeed += stats.maxSpeed;
                        luck += stats.luck;
                        power += stats.power;
                    }
                }
            });

            return { speed, grip, accel, maxSpeed, luck, power };
        }

        function getCoins() {
            return parseInt(localStorage.getItem(COINS_KEY)) || 1000;
        }

        function addCoins(amount) {
            const newAmount = getCoins() + amount;
            localStorage.setItem(COINS_KEY, newAmount);
            document.getElementById('coinsDisplay').textContent = newAmount + ' ü™ô';
        }

        function showNotification(text, isError = false) {
            const n = document.getElementById('notification');
            n.textContent = isError ? '‚ùå ' + text : '‚ú® ' + text;
            n.classList.add('show');
            setTimeout(() => n.classList.remove('show'), 2000);
        }

        function showChest() {
            const chestDiv = document.createElement('div');
            chestDiv.className = 'chest-container';
            chestDiv.innerHTML = `
                <div class="chest">üéÅ</div>
                <div class="chest-message">–ù–ê–ô–î–ï–ù –°–£–ù–î–£–ö!</div>
            `;
            chestDiv.onclick = function() {
                const colors = ['red', 'green', 'blue', 'yellow', 'orange', 'purple'];
                const randomColor = colors[Math.floor(Math.random() * colors.length)];
                
                let inventory = JSON.parse(localStorage.getItem(INVENTORY_KEY)) || [];
                inventory.push({ color: randomColor, rarity: 'common' });
                localStorage.setItem(INVENTORY_KEY, JSON.stringify(inventory));

                chestDiv.innerHTML = `
                    <div class="chest">‚ú®</div>
                    <div class="chest-message">+1 ${randomColor} –∫—É–±!</div>
                `;
                setTimeout(() => chestDiv.remove(), 2000);
            };
            document.body.appendChild(chestDiv);
        }

        function startRace() {
            if (raceActive) return;

            playerStats = loadPlayerStats();
            
            // –ü—Ä–æ—Ç–∏–≤–Ω–∏–∫ 90-110% –æ—Ç –∏–≥—Ä–æ–∫–∞
            enemyStats = {
                speed: playerStats.speed * (0.9 + Math.random() * 0.2),
                grip: playerStats.grip * (0.9 + Math.random() * 0.2),
                accel: playerStats.accel * (0.9 + Math.random() * 0.2),
                maxSpeed: playerStats.maxSpeed * (0.9 + Math.random() * 0.2),
                luck: playerStats.luck * (0.9 + Math.random() * 0.2),
                power: playerStats.power * (0.9 + Math.random() * 0.2)
            };

            playerProgress = 0;
            enemyProgress = 0;
            playerSpeed = 0;
            enemySpeed = 0;

            raceActive = true;
            document.getElementById('startRaceBtn').disabled = true;
            document.getElementById('stopRaceBtn').disabled = false;
            document.getElementById('raceStatus').textContent = '–ì–û–ù–ö–ê! üí®';

            let raceTime = 0;

            raceInterval = setInterval(() => {
                if (!raceActive) return;

                raceTime++;

                // –ò–≥—Ä–æ–∫
                if (playerSpeed < playerStats.maxSpeed) {
                    playerSpeed += playerStats.accel * (0.8 + Math.random() * 0.4);
                }

                // –£–¥–∞—á–∞
                if (Math.random() < playerStats.luck) {
                    playerSpeed *= 1.3;
                }

                // –°—Ü–µ–ø–ª–µ–Ω–∏–µ –≤–ª–∏—è–µ—Ç –Ω–∞ –ø–æ—Ç–µ—Ä—é —Å–∫–æ—Ä–æ—Å—Ç–∏
                if (Math.random() < 0.05 * (1 - playerStats.grip/100)) {
                    playerSpeed *= 0.7;
                }

                // –ü—Ä–æ—Ç–∏–≤–Ω–∏–∫
                if (enemySpeed < enemyStats.maxSpeed) {
                    enemySpeed += enemyStats.accel * (0.7 + Math.random() * 0.6);
                }

                if (Math.random() < 0.02) enemySpeed *= 0.3;
                if (Math.random() < 0.01) enemySpeed *= 1.5;

                playerProgress += playerSpeed / 100;
                enemyProgress += enemySpeed / 100;

                // –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –¥–æ –¥–ª–∏–Ω—ã —Ç—Ä–∞—Å—Å—ã
                playerProgress = Math.min(playerProgress, 100);
                enemyProgress = Math.min(enemyProgress, 100);

                // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ UI
                document.getElementById('progressBar').style.width = playerProgress + '%';
                document.getElementById('playerSpeed').textContent = Math.floor(playerSpeed);
                document.getElementById('enemySpeed').textContent = Math.floor(enemySpeed);

                // –î–≤–∏–∂–µ–Ω–∏–µ –º–∞—à–∏–Ω –≤ 3D
                const trackLength = 30;
                playerCarGroup.position.z = -trackLength/2 + 2 + (playerProgress / 100) * (trackLength - 4);
                enemyCarGroup.position.z = -trackLength/2 + 1.5 + (enemyProgress / 100) * (trackLength - 4);

                // –§–∏–Ω–∏—à
                if (playerProgress >= 100 || enemyProgress >= 100) {
                    finishRace();
                }
            }, 50);
        }

        function finishRace() {
            raceActive = false;
            clearInterval(raceInterval);

            document.getElementById('startRaceBtn').disabled = false;
            document.getElementById('stopRaceBtn').disabled = true;

            const resultDiv = document.getElementById('raceResult');
            const resultTitle = document.getElementById('resultTitle');
            const resultReward = document.getElementById('resultReward');

            const playerFinished = playerProgress >= 100;
            const enemyFinished = enemyProgress >= 100;

            if (playerFinished && !enemyFinished) {
                const reward = 100 + Math.floor(Math.random() * 100);
                addCoins(reward);

                if (Math.random() < 0.25) {
                    showChest();
                }

                resultDiv.className = 'race-result result-win';
                resultTitle.textContent = 'üèÜ –ü–û–ë–ï–î–ê üèÜ';
                resultReward.textContent = `+${reward} –ú–û–ù–ï–¢`;
                document.getElementById('raceStatus').textContent = '–¢–´ –ü–û–ë–ï–î–ò–õ!';
            } 
            else if (!playerFinished && enemyFinished) {
                resultDiv.className = 'race-result result-lose';
                resultTitle.textContent = 'üò¢ –ü–û–†–ê–ñ–ï–ù–ò–ï';
                resultReward.textContent = '';
                document.getElementById('raceStatus').textContent = '–ö–ò–†–Æ–•–ê –ü–û–ë–ï–î–ò–õ';
            }
            else {
                if (playerProgress > enemyProgress) {
                    addCoins(50);
                    if (Math.random() < 0.25) {
                        showChest();
                    }
                    resultDiv.className = 'race-result result-win';
                    resultTitle.textContent = 'ü§ù –§–û–¢–û–§–ò–ù–ò–®';
                    resultReward.textContent = '+50 –ú–û–ù–ï–¢';
                } else {
                    resultDiv.className = 'race-result result-lose';
                    resultTitle.textContent = 'üò¢ –§–û–¢–û–§–ò–ù–ò–®';
                    resultReward.textContent = '';
                }
            }

            resultDiv.style.display = 'block';
        }

        function stopRace() {
            if (!raceActive) return;
            raceActive = false;
            clearInterval(raceInterval);
            document.getElementById('startRaceBtn').disabled = false;
            document.getElementById('stopRaceBtn').disabled = true;
            document.getElementById('raceStatus').textContent = '–ì–û–ù–ö–ê –û–°–¢–ê–ù–û–í–õ–ï–ù–ê';
        }

        function closeResult() {
            document.getElementById('raceResult').style.display = 'none';
        }

        // --- Telegram –∏ –º–æ–Ω–µ—Ç—ã ---
        if (window.Telegram?.WebApp) {
            window.Telegram.WebApp.ready();
            window.Telegram.WebApp.expand();
        }

        document.getElementById('coinsDisplay').textContent = getCoins() + ' ü™ô';
    </script>
</body>
    </html>
