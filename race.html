<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ton Racing ‚Äì 3D –ì–æ–Ω–∫–∞</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Racing Sans One', 'Segoe UI', system-ui, sans-serif;
            background: #0c0c0c;
            color: white;
            overflow: hidden;
        }

        #canvas-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 1;
        }

        #ui-container {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 10;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            padding: 20px;
        }

        /* –í–µ—Ä—Ö–Ω—è—è —à–∞–ø–∫–∞ */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: rgba(0,0,0,0.6);
            border: 1px solid #e10600;
            padding: 8px 16px;
            clip-path: polygon(5px 0, 100% 0, 100% calc(100% - 5px), calc(100% - 5px) 100%, 0 100%, 0 5px);
            pointer-events: auto;
            backdrop-filter: blur(5px);
            max-width: 1200px;
            margin: 0 auto;
            width: 100%;
            z-index: 100;
        }

        .back-to-menu {
            color: white;
            text-decoration: none;
            font-weight: bold;
            font-size: 14px;
            padding: 4px 10px;
            border: 1px solid #e10600;
            clip-path: polygon(3px 0, 100% 0, 100% calc(100% - 3px), calc(100% - 3px) 100%, 0 100%, 0 3px);
            transition: 0.2s;
        }

        .back-to-menu:active {
            background: #e10600;
            color: black;
        }

        .coins-header {
            background: linear-gradient(135deg, #e10600, #ff4d4d);
            padding: 4px 12px;
            font-weight: bold;
            font-size: 14px;
            clip-path: polygon(5px 0, 100% 0, 100% 100%, 0 100%, 0 5px);
        }

        /* –ù–∞–≤–∏–≥–∞—Ü–∏–æ–Ω–Ω–æ–µ –º–µ–Ω—é */
        .nav-menu {
            display: flex;
            gap: 8px;
            justify-content: center;
            margin: 10px auto;
            pointer-events: auto;
            max-width: 1200px;
        }

        .nav-item {
            width: 40px;
            height: 40px;
            background: rgba(0,0,0,0.7);
            border: 1px solid #e10600;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            text-decoration: none;
            color: white;
            clip-path: polygon(3px 0, 100% 0, 100% calc(100% - 3px), calc(100% - 3px) 100%, 0 100%, 0 3px);
            transition: 0.2s;
        }

        .nav-item:hover {
            background: #e10600;
            color: black;
        }

        .nav-item.active {
            background: #e10600;
            color: black;
            box-shadow: 0 0 10px #e10600;
        }

        /* –ü–∞–Ω–µ–ª—å –≥–æ–Ω–∫–∏ –≤–Ω–∏–∑—É */
        .race-panel {
            background: rgba(0,0,0,0.7);
            border: 2px solid #e10600;
            padding: 15px;
            clip-path: polygon(10px 0, 100% 0, 100% calc(100% - 10px), calc(100% - 10px) 100%, 0 100%, 0 10px);
            pointer-events: auto;
            backdrop-filter: blur(5px);
            width: 100%;
            max-width: 600px;
            margin: 0 auto 20px;
            z-index: 50;
        }

        .race-status {
            text-align: center;
            font-size: 20px;
            color: #e10600;
            text-transform: uppercase;
            letter-spacing: 2px;
            margin-bottom: 10px;
            animation: blink 1s infinite;
        }

        @keyframes blink {
            50% { opacity: 0.5; }
        }

        .progress-container {
            background: rgba(255,255,255,0.1);
            border: 1px solid #e10600;
            padding: 5px;
            margin-bottom: 10px;
        }

        .progress-bar {
            height: 15px;
            background: linear-gradient(90deg, #e10600, #ff4d4d);
            width: 0%;
            transition: width 0.1s linear;
            clip-path: polygon(3px 0, 100% 0, 100% calc(100% - 3px), calc(100% - 3px) 100%, 0 100%, 0 3px);
        }

        .progress-labels {
            display: flex;
            justify-content: space-between;
            margin-top: 3px;
            color: #e10600;
            font-size: 12px;
        }

        .race-stats {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-bottom: 10px;
        }

        .stat-card {
            background: rgba(0,0,0,0.5);
            border: 1px solid #e10600;
            padding: 8px 15px;
            clip-path: polygon(3px 0, 100% 0, 100% calc(100% - 3px), calc(100% - 3px) 100%, 0 100%, 0 3px);
            text-align: center;
            flex: 1;
        }

        .stat-label {
            color: #e10600;
            font-size: 11px;
            text-transform: uppercase;
        }

        .stat-value {
            font-size: 18px;
            font-weight: bold;
            color: white;
        }

        .race-controls {
            display: flex;
            gap: 15px;
            justify-content: center;
        }

        .race-btn {
            background: rgba(0,0,0,0.7);
            border: 1px solid #e10600;
            color: white;
            font-size: 16px;
            font-weight: bold;
            padding: 10px 25px;
            cursor: pointer;
            transition: 0.3s;
            text-transform: uppercase;
            letter-spacing: 1px;
            clip-path: polygon(5px 0, 100% 0, 100% calc(100% - 5px), calc(100% - 5px) 100%, 0 100%, 0 5px);
            flex: 1;
            max-width: 150px;
        }

        .race-btn:hover:not(:disabled) {
            background: #e10600;
            color: black;
        }

        .race-btn:disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }

        .race-btn.stop {
            border-color: #f00;
        }
        .race-btn.stop:hover:not(:disabled) {
            background: #f00;
        }

        /* –†–µ–∑—É–ª—å—Ç–∞—Ç –≥–æ–Ω–∫–∏ */
        .race-result {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0,0,0,0.95);
            border: 3px solid;
            padding: 30px 50px;
            text-align: center;
            z-index: 200;
            backdrop-filter: blur(10px);
            clip-path: polygon(15px 0, 100% 0, 100% calc(100% - 15px), calc(100% - 15px) 100%, 0 100%, 0 15px);
            display: none;
            pointer-events: auto;
        }

        .result-win {
            border-color: #0f0;
            box-shadow: 0 0 50px #0f0;
        }

        .result-lose {
            border-color: #f00;
            box-shadow: 0 0 50px #f00;
        }

        .result-title {
            font-size: 40px;
            font-weight: bold;
            margin-bottom: 15px;
        }

        .result-win .result-title { color: #0f0; text-shadow: 0 0 30px #0f0; }
        .result-lose .result-title { color: #f00; text-shadow: 0 0 30px #f00; }

        .result-reward {
            font-size: 28px;
            color: #fff;
            margin-bottom: 20px;
        }

        .result-btn {
            background: transparent;
            border: 2px solid #e10600;
            color: white;
            padding: 10px 30px;
            font-size: 18px;
            cursor: pointer;
            clip-path: polygon(5px 0, 100% 0, 100% calc(100% - 5px), calc(100% - 5px) 100%, 0 100%, 0 5px);
        }

        .result-btn:hover {
            background: #e10600;
            color: black;
        }

        /* –°—É–Ω–¥—É–∫ */
        .chest-container {
            position: fixed;
            top: 30%;
            left: 50%;
            transform: translateX(-50%);
            text-align: center;
            z-index: 150;
            pointer-events: auto;
            animation: chestFloat 1s infinite alternate;
        }

        .chest {
            font-size: 80px;
            cursor: pointer;
            filter: drop-shadow(0 0 30px gold);
        }

        .chest-message {
            color: gold;
            font-size: 20px;
            font-weight: bold;
            text-shadow: 0 0 20px gold;
        }

        @keyframes chestFloat {
            from { transform: translateX(-50%) translateY(0); }
            to { transform: translateX(-50%) translateY(-15px); }
        }

        /* –¢–µ–ª–µ–º–µ—Ç—Ä–∏—è */
        .f1-telemetry {
            position: fixed;
            bottom: 20px;
            right: 20px;
            display: flex;
            gap: 5px;
            background: rgba(0,0,0,0.6);
            border: 1px solid #e10600;
            padding: 8px 15px;
            clip-path: polygon(5px 0, 100% 0, 100% calc(100% - 5px), calc(100% - 5px) 100%, 0 100%, 0 5px);
            z-index: 100;
            pointer-events: none;
        }

        .telemetry-dot {
            width: 12px;
            height: 12px;
            transform: rotate(45deg);
            box-shadow: 0 0 8px currentColor;
        }

        .telemetry-dot.red { background: #ff4444; }
        .telemetry-dot.green { background: #44ff44; }
        .telemetry-dot.blue { background: #4444ff; }
        .telemetry-dot.yellow { background: #ffff44; }
        .telemetry-dot.orange { background: #ff8844; }
        .telemetry-dot.purple { background: #ff44ff; }

        .exit-btn {
            position: fixed;
            bottom: 20px;
            left: 20px;
            background: transparent;
            border: 1px solid #e10600;
            color: #e10600;
            padding: 6px 15px;
            font-weight: bold;
            cursor: pointer;
            transition: 0.3s;
            text-decoration: none;
            text-transform: uppercase;
            letter-spacing: 1px;
            backdrop-filter: blur(5px);
            font-size: 12px;
            z-index: 100;
            clip-path: polygon(0 0, 100% 0, 100% calc(100% - 3px), calc(100% - 3px) 100%, 0 100%, 0 3px);
            pointer-events: auto;
        }

        .exit-btn:hover {
            background: #e10600;
            color: #000;
        }

        .notification {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: #e10600;
            color: white;
            padding: 8px 20px;
            font-weight: bold;
            z-index: 300;
            display: none;
            font-size: 14px;
            white-space: nowrap;
            box-shadow: 0 0 20px #e10600;
            clip-path: polygon(0 0, 100% 0, 100% calc(100% - 3px), calc(100% - 3px) 100%, 0 100%, 0 3px);
            pointer-events: none;
        }

        .notification.show {
            display: block;
            animation: slideIn 0.3s;
        }
        @keyframes slideIn {
            from { transform: translateX(-50%) translateY(-100%); }
            to { transform: translateX(-50%) translateY(0); }
        }

        @media (max-width: 600px) {
            .race-panel {
                padding: 10px;
            }
            .stat-card {
                padding: 5px 10px;
            }
            .stat-value {
                font-size: 16px;
            }
            .race-btn {
                padding: 8px 15px;
                font-size: 14px;
            }
        }
    </style>
</head>
<body>
    <div id="canvas-container"></div>

    <div id="ui-container">
        <div class="header">
            <a href="index.html" class="back-to-menu">‚Üê –ú–ï–ù–Æ</a>
            <div class="coins-header" id="coinsDisplay">1000 ü™ô</div>
        </div>

        <div class="nav-menu">
            <a href="garage.html" class="nav-item">üîß</a>
            <a href="race.html" class="nav-item active">üèÅ</a>
            <a href="shop.html" class="nav-item">üõí</a>
            <a href="rating.html" class="nav-item">üìä</a>
        </div>

        <div style="flex:1"></div>

        <div class="race-panel">
            <div class="race-status" id="raceStatus">–ì–û–¢–û–í –ö –ì–û–ù–ö–ï</div>
            
            <div class="progress-container">
                <div class="progress-bar" id="progressBar" style="width: 0%"></div>
                <div class="progress-labels">
                    <span>–°–¢–ê–†–¢</span>
                    <span>–§–ò–ù–ò–®</span>
                </div>
            </div>

            <div class="race-stats">
                <div class="stat-card">
                    <div class="stat-label">–¢–í–û–Ø –°–ö–û–†–û–°–¢–¨</div>
                    <div class="stat-value" id="playerSpeed">0</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">–°–ö–û–†–û–°–¢–¨ –ö–ò–†–Æ–•–ò</div>
                    <div class="stat-value" id="enemySpeed">0</div>
                </div>
            </div>

            <div class="race-controls">
                <button class="race-btn start" id="startRaceBtn" onclick="startRace()">üèÅ –°–¢–ê–†–¢</button>
                <button class="race-btn stop" id="stopRaceBtn" onclick="stopRace()" disabled>‚èπ –°–¢–û–ü</button>
            </div>
        </div>
    </div>

    <div id="raceResult" class="race-result">
        <div class="result-title" id="resultTitle"></div>
        <div class="result-reward" id="resultReward"></div>
        <button class="result-btn" onclick="closeResult()">–û–ö</button>
    </div>

    <div class="f1-telemetry">
        <div class="telemetry-dot red"></div>
        <div class="telemetry-dot green"></div>
        <div class="telemetry-dot blue"></div>
        <div class="telemetry-dot yellow"></div>
        <div class="telemetry-dot orange"></div>
        <div class="telemetry-dot purple"></div>
    </div>

    <a href="#" class="exit-btn" onclick="window.Telegram?.WebApp?.close()">‚úñ –í–´–•–û–î</a>
    <div id="notification" class="notification"></div>

    <script type="importmap">
        {
            "imports": {
                "three": "https://unpkg.com/three@0.128.0/build/three.module.js",
                "three/addons/": "https://unpkg.com/three@0.128.0/examples/jsm/"
            }
        }
    </script>

    <script type="module">
        import * as THREE from 'three';
        import { OrbitControls } from 'https://unpkg.com/three@0.128.0/examples/jsm/controls/OrbitControls.js';
        import { OBJLoader } from 'https://unpkg.com/three@0.128.0/examples/jsm/loaders/OBJLoader.js';
        import { MTLLoader } from 'https://unpkg.com/three@0.128.0/examples/jsm/loaders/MTLLoader.js';

        // --- 3D –°–¶–ï–ù–ê ---
        const container = document.getElementById('canvas-container');
        const scene = new THREE.Scene();
        scene.background = new THREE.Color(0x0a0a14);

        // –ö–∞–º–µ—Ä–∞ (–≤–∏–¥ —Å–∑–∞–¥–∏-—Å–±–æ–∫—É, —á—Ç–æ–±—ã –≤–∏–¥–µ—Ç—å –¥–≤–∏–∂–µ–Ω–∏–µ)
        const camera = new THREE.PerspectiveCamera(60, window.innerWidth / window.innerHeight, 0.1, 1000);
        camera.position.set(6, 3, 12);
        camera.lookAt(0, 0.5, 5);

        const renderer = new THREE.WebGLRenderer({ antialias: true, alpha: false });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.shadowMap.enabled = true;
        renderer.shadowMap.type = THREE.PCFSoftShadowMap;
        renderer.setPixelRatio(window.devicePixelRatio);
        container.appendChild(renderer.domElement);

        // --- –û—Å–≤–µ—â–µ–Ω–∏–µ ---
        const ambientLight = new THREE.AmbientLight(0x404060);
        scene.add(ambientLight);

        const dirLight = new THREE.DirectionalLight(0xffaa88, 1.2);
        dirLight.position.set(5, 10, 7);
        dirLight.castShadow = true;
        dirLight.shadow.mapSize.width = 1024;
        dirLight.shadow.mapSize.height = 1024;
        dirLight.shadow.camera.near = 0.5;
        dirLight.shadow.camera.far = 30;
        dirLight.shadow.camera.left = -10;
        dirLight.shadow.camera.right = 10;
        dirLight.shadow.camera.top = 10;
        dirLight.shadow.camera.bottom = -10;
        scene.add(dirLight);

        const backLight = new THREE.PointLight(0x4466ff, 0.8);
        backLight.position.set(-3, 2, -10);
        scene.add(backLight);

        const fillLight = new THREE.PointLight(0x44ff88, 0.5);
        fillLight.position.set(3, 1, 5);
        scene.add(fillLight);

        // --- –¢—Ä–∞—Å—Å–∞ ---
        const trackLength = 30;
        const trackWidth = 4.5;

        // –ê—Å—Ñ–∞–ª—å—Ç
        const trackGeo = new THREE.PlaneGeometry(trackWidth, trackLength);
        const trackMat = new THREE.MeshStandardMaterial({ color: 0x222222, roughness: 0.8, metalness: 0.1 });
        const track = new THREE.Mesh(trackGeo, trackMat);
        track.rotation.x = -Math.PI / 2;
        track.position.set(0, -0.1, 0);
        track.receiveShadow = true;
        scene.add(track);

        // –†–∞–∑–º–µ—Ç–∫–∞ (—Ü–µ–Ω—Ç—Ä)
        const centerLineGeo = new THREE.PlaneGeometry(0.3, trackLength);
        const centerLineMat = new THREE.MeshStandardMaterial({ color: 0xffaa00 });
        const centerLine = new THREE.Mesh(centerLineGeo, centerLineMat);
        centerLine.rotation.x = -Math.PI / 2;
        centerLine.position.set(0, -0.09, 0);
        centerLine.receiveShadow = true;
        scene.add(centerLine);

        // –ë–æ–∫–æ–≤—ã–µ –ø–æ–ª–æ—Å—ã
        const stripeGeo = new THREE.PlaneGeometry(0.3, trackLength);
        const stripeMat = new THREE.MeshStandardMaterial({ color: 0xffffff });
        
        const leftStripe = new THREE.Mesh(stripeGeo, stripeMat);
        leftStripe.rotation.x = -Math.PI / 2;
        leftStripe.position.set(-trackWidth/2 - 0.2, -0.09, 0);
        leftStripe.receiveShadow = true;
        scene.add(leftStripe);

        const rightStripe = new THREE.Mesh(stripeGeo, stripeMat);
        rightStripe.rotation.x = -Math.PI / 2;
        rightStripe.position.set(trackWidth/2 + 0.2, -0.09, 0);
        rightStripe.receiveShadow = true;
        scene.add(rightStripe);

        // –°—Ç–∞—Ä—Ç–æ–≤–∞—è –ª–∏–Ω–∏—è
        const startGeo = new THREE.PlaneGeometry(trackWidth, 0.8);
        const startMat = new THREE.MeshStandardMaterial({ color: 0xffffff });
        const startLine = new THREE.Mesh(startGeo, startMat);
        startLine.rotation.x = -Math.PI / 2;
        startLine.position.set(0, -0.08, -trackLength/2 + 2);
        startLine.receiveShadow = true;
        scene.add(startLine);

        // –§–∏–Ω–∏—à–Ω–∞—è –ª–∏–Ω–∏—è
        const finishGeo = new THREE.PlaneGeometry(trackWidth, 0.8);
        const finishMat = new THREE.MeshStandardMaterial({ color: 0xe10600 });
        const finishLine = new THREE.Mesh(finishGeo, finishMat);
        finishLine.rotation.x = -Math.PI / 2;
        finishLine.position.set(0, -0.08, trackLength/2 - 2);
        finishLine.receiveShadow = true;
        scene.add(finishLine);

        // –ó—Ä–∏—Ç–µ–ª–∏ (–∫—É–±—ã)
        const colors = [0xe10600, 0xffaa00, 0x44ff44, 0x4444ff];
        for (let i = -2; i <= 2; i+=1) {
            for (let j = -trackLength/2 + 3; j < trackLength/2 - 3; j+=4) {
                const boxGeo = new THREE.BoxGeometry(0.5, 0.8, 0.5);
                const boxMat = new THREE.MeshStandardMaterial({ color: colors[Math.floor(Math.random() * colors.length)] });
                const box = new THREE.Mesh(boxGeo, boxMat);
                box.position.set(i * 2.5, 0.4, j);
                box.castShadow = true;
                box.receiveShadow = true;
                scene.add(box);
            }
        }

        // --- –ú–∞—à–∏–Ω—ã ---
        let playerCar = null;
        let enemyCar = null;

        // –ó–∞–≥—Ä—É–∑–∫–∞ –º–æ–¥–µ–ª–∏
        const mtlLoader = new MTLLoader();
        const objLoader = new OBJLoader();

        function createFallbackCars() {
            console.log('–°–æ–∑–¥–∞—ë–º –º–∞—à–∏–Ω—ã-–∑–∞–≥–ª—É—à–∫–∏');
            
            // –ú–∞—à–∏–Ω–∞ –∏–≥—Ä–æ–∫–∞
            const playerCarGroup = new THREE.Group();
            
            const bodyGeo = new THREE.BoxGeometry(1.2, 0.4, 2.0);
            const bodyMat = new THREE.MeshStandardMaterial({ color: 0xff4444 });
            const body = new THREE.Mesh(bodyGeo, bodyMat);
            body.position.set(0, 0.3, 0);
            body.castShadow = true;
            body.receiveShadow = true;
            playerCarGroup.add(body);

            const wheelGeo = new THREE.CylinderGeometry(0.3, 0.3, 0.2, 16);
            const wheelMat = new THREE.MeshStandardMaterial({ color: 0x333333 });
            const positions = [[-0.7, 0.2, 0.7], [0.7, 0.2, 0.7], [-0.7, 0.2, -0.7], [0.7, 0.2, -0.7]];
            positions.forEach((pos) => {
                const wheel = new THREE.Mesh(wheelGeo, wheelMat);
                wheel.rotation.z = Math.PI/2;
                wheel.position.set(pos[0], pos[1], pos[2]);
                wheel.castShadow = true;
                wheel.receiveShadow = true;
                playerCarGroup.add(wheel);
            });
            
            playerCarGroup.position.set(0, 0.2, -trackLength/2 + 2);
            scene.add(playerCarGroup);
            playerCar = playerCarGroup;

            // –ú–∞—à–∏–Ω–∞ –ø—Ä–æ—Ç–∏–≤–Ω–∏–∫–∞
            const enemyCarGroup = new THREE.Group();
            
            const enemyBody = new THREE.Mesh(bodyGeo, new THREE.MeshStandardMaterial({ color: 0x4444ff }));
            enemyBody.position.set(0, 0.3, 0);
            enemyBody.castShadow = true;
            enemyBody.receiveShadow = true;
            enemyCarGroup.add(enemyBody);

            positions.forEach((pos) => {
                const wheel = new THREE.Mesh(wheelGeo, wheelMat);
                wheel.rotation.z = Math.PI/2;
                wheel.position.set(pos[0], pos[1], pos[2]);
                wheel.castShadow = true;
                wheel.receiveShadow = true;
                enemyCarGroup.add(wheel);
            });
            
            enemyCarGroup.position.set(0, 0.2, -trackLength/2 + 1);
            scene.add(enemyCarGroup);
            enemyCar = enemyCarGroup;
        }

        mtlLoader.load(
            'models/2107.mtl',
            (materials) => {
                materials.preload();
                objLoader.setMaterials(materials);
                
                objLoader.load(
                    'models/2107.obj',
                    (object) => {
                        console.log('–ú–æ–¥–µ–ª—å 2107 –∑–∞–≥—Ä—É–∂–µ–Ω–∞ –¥–ª—è –≥–æ–Ω–∫–∏');
                        
                        // –ú–∞—à–∏–Ω–∞ –∏–≥—Ä–æ–∫–∞ (–∫—Ä–∞—Å–Ω–∞—è)
                        playerCar = object.clone();
                        playerCar.scale.set(0.5, 0.5, 0.5);
                        playerCar.position.set(0, 0.2, -trackLength/2 + 2);
                        playerCar.rotation.y = 0;
                        
                        playerCar.traverse((child) => {
                            if (child.isMesh) {
                                child.castShadow = true;
                                child.receiveShadow = true;
                                if (child.material) {
                                    if (Array.isArray(child.material)) {
                                        child.material.forEach(mat => mat.color.setHex(0xff4444));
                                    } else {
                                        child.material.color.setHex(0xff4444);
                                    }
                                }
                            }
                        });
                        scene.add(playerCar);

                        // –ú–∞—à–∏–Ω–∞ –ø—Ä–æ—Ç–∏–≤–Ω–∏–∫–∞ (—Å–∏–Ω—è—è)
                        enemyCar = object.clone();
                        enemyCar.scale.set(0.5, 0.5, 0.5);
                        enemyCar.position.set(0, 0.2, -trackLength/2 + 1);
                        enemyCar.rotation.y = 0;
                        
                        enemyCar.traverse((child) => {
                            if (child.isMesh) {
                                child.castShadow = true;
                                child.receiveShadow = true;
                                if (child.material) {
                                    if (Array.isArray(child.material)) {
                                        child.material.forEach(mat => mat.color.setHex(0x4444ff));
                                    } else {
                                        child.material.color.setHex(0x4444ff);
                                    }
                                }
                            }
                        });
                        scene.add(enemyCar);
                    },
                    (xhr) => {
                        console.log((xhr.loaded / xhr.total * 100) + '% –∑–∞–≥—Ä—É–∂–µ–Ω–æ');
                    },
                    (error) => {
                        console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ OBJ:', error);
                        createFallbackCars();
                    }
                );
            },
            undefined,
            (error) => {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ MTL:', error);
                // –ü—Ä–æ–±—É–µ–º –±–µ–∑ –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤
                objLoader.load(
                    'models/2107.obj',
                    (object) => {
                        console.log('–ú–æ–¥–µ–ª—å –∑–∞–≥—Ä—É–∂–µ–Ω–∞ –±–µ–∑ –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤');
                        
                        playerCar = object.clone();
                        playerCar.scale.set(0.5, 0.5, 0.5);
                        playerCar.position.set(0, 0.2, -trackLength/2 + 2);
                        playerCar.rotation.y = 0;
                        scene.add(playerCar);

                        enemyCar = object.clone();
                        enemyCar.scale.set(0.5, 0.5, 0.5);
                        enemyCar.position.set(0, 0.2, -trackLength/2 + 1);
                        enemyCar.rotation.y = 0;
                        scene.add(enemyCar);
                    },
                    undefined,
                    (error) => {
                        console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ OBJ –±–µ–∑ –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤:', error);
                        createFallbackCars();
                    }
                );
            }
        );

        // –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–∞–º–µ—Ä–æ–π
        const controls = new OrbitControls(camera, renderer.domElement);
        controls.enableDamping = true;
        controls.dampingFactor = 0.05;
        controls.autoRotate = false;
        controls.enableZoom = true;
        controls.enablePan = false;
        controls.maxPolarAngle = Math.PI / 2.5;
        controls.target.set(0, 0.5, 5);

        function animate() {
            requestAnimationFrame(animate);
            controls.update();
            renderer.render(scene, camera);
        }
        animate();

        window.addEventListener('resize', () => {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        });

        // --- –õ–û–ì–ò–ö–ê –ì–û–ù–ö–ò ---
        const COINS_KEY = 'playerCoins';
        const ACTIVE_CUBES_KEY = 'activeCubes';
        const INVENTORY_KEY = 'playerInventory';

        let raceInterval = null;
        let raceActive = false;
        let playerProgress = 0;
        let enemyProgress = 0;
        let playerSpeed = 0;
        let enemySpeed = 0;
        let playerStats = null;
        let enemyStats = null;

        const cubeStats = {
            red:    { speed: 30, grip: 0, accel: 0, maxSpeed: 0, luck: 0, power: 0 },
            green:  { speed: 0, grip: 20, accel: 0, maxSpeed: 0, luck: 0, power: 0 },
            blue:   { speed: 0, grip: 0, accel: 0, maxSpeed: 30, luck: 0, power: 0 },
            yellow: { speed: 0, grip: 0, accel: 0, maxSpeed: 0, luck: 0.2, power: 0 },
            orange: { speed: 0, grip: 0, accel: 3, maxSpeed: 0, luck: 0, power: 0 },
            purple: { speed: 0, grip: 0, accel: 0, maxSpeed: 0, luck: 0, power: 20 }
        };

        function loadPlayerStats() {
            const activeCubes = JSON.parse(localStorage.getItem(ACTIVE_CUBES_KEY)) || [];
            
            let speed = 50;
            let grip = 50;
            let accel = 5;
            let maxSpeed = 100;
            let luck = 0;
            let power = 100;

            activeCubes.forEach((cube) => {
                if (cube) {
                    const color = cube.color;
                    const stats = cubeStats[color];
                    if (stats) {
                        speed += stats.speed;
                        grip += stats.grip;
                        accel += stats.accel;
                        maxSpeed += stats.maxSpeed;
                        luck += stats.luck;
                        power += stats.power;
                    }
                }
            });

            return { speed, grip, accel, maxSpeed, luck, power };
        }

        function getCoins() {
            return parseInt(localStorage.getItem(COINS_KEY)) || 1000;
        }

        function addCoins(amount) {
            const newAmount = getCoins() + amount;
            localStorage.setItem(COINS_KEY, newAmount);
            document.getElementById('coinsDisplay').textContent = newAmount + ' ü™ô';
        }

        function showNotification(text, isError = false) {
            const n = document.getElementById('notification');
            n.textContent = isError ? '‚ùå ' + text : '‚ú® ' + text;
            n.classList.add('show');
            setTimeout(() => n.classList.remove('show'), 2000);
        }

        function showChest() {
            const chestDiv = document.createElement('div');
            chestDiv.className = 'chest-container';
            chestDiv.innerHTML = `
                <div class="chest">üéÅ</div>
                <div class="chest-message">–ù–ê–ô–î–ï–ù –°–£–ù–î–£–ö!</div>
            `;
            chestDiv.onclick = function() {
                const colors = ['red', 'green', 'blue', 'yellow', 'orange', 'purple'];
                const randomColor = colors[Math.floor(Math.random() * colors.length)];
                
                let inventory = JSON.parse(localStorage.getItem(INVENTORY_KEY)) || [];
                inventory.push({ color: randomColor, rarity: 'common' });
                localStorage.setItem(INVENTORY_KEY, JSON.stringify(inventory));

                chestDiv.innerHTML = `
                    <div class="chest">‚ú®</div>
                    <div class="chest-message">+1 ${randomColor} –∫—É–±!</div>
                `;
                setTimeout(() => chestDiv.remove(), 2000);
            };
            document.body.appendChild(chestDiv);
        }

        window.startRace = function() {
            if (raceActive) return;

            playerStats = loadPlayerStats();
            
            enemyStats = {
                speed: playerStats.speed * (0.9 + Math.random() * 0.2),
                grip: playerStats.grip * (0.9 + Math.random() * 0.2),
                accel: playerStats.accel * (0.9 + Math.random() * 0.2),
                maxSpeed: playerStats.maxSpeed * (0.9 + Math.random() * 0.2),
                luck: playerStats.luck * (0.9 + Math.random() * 0.2),
                power: playerStats.power * (0.9 + Math.random() * 0.2)
            };

            playerProgress = 0;
            enemyProgress = 0;
            playerSpeed = 0;
            enemySpeed = 0;

            raceActive = true;
            document.getElementById('startRaceBtn').disabled = true;
            document.getElementById('stopRaceBtn').disabled = false;
            document.getElementById('raceStatus').textContent = '–ì–û–ù–ö–ê! üí®';

            let raceTime = 0;

            raceInterval = setInterval(() => {
                if (!raceActive) return;

                raceTime++;

                if (playerSpeed < playerStats.maxSpeed) {
                    playerSpeed += playerStats.accel * (0.8 + Math.random() * 0.4);
                }

                if (Math.random() < playerStats.luck) {
                    playerSpeed *= 1.3;
                }

                if (Math.random() < 0.05 * (1 - playerStats.grip/100)) {
                    playerSpeed *= 0.7;
                }

                if (enemySpeed < enemyStats.maxSpeed) {
                    enemySpeed += enemyStats.accel * (0.7 + Math.random() * 0.6);
                }

                if (Math.random() < 0.02) enemySpeed *= 0.3;
                if (Math.random() < 0.01) enemySpeed *= 1.5;

                playerProgress += playerSpeed / 150;
                enemyProgress += enemySpeed / 150;

                playerProgress = Math.min(playerProgress, 100);
                enemyProgress = Math.min(enemyProgress, 100);

                document.getElementById('progressBar').style.width = playerProgress + '%';
                document.getElementById('playerSpeed').textContent = Math.floor(playerSpeed);
                document.getElementById('enemySpeed').textContent = Math.floor(enemySpeed);

                // –î–≤–∏–≥–∞–µ–º –º–∞—à–∏–Ω—ã –ø–æ —Ç—Ä–∞—Å—Å–µ
                if (playerCar) {
                    playerCar.position.z = -trackLength/2 + 2 + (playerProgress / 100) * (trackLength - 4);
                }
                if (enemyCar) {
                    enemyCar.position.z = -trackLength/2 + 1 + (enemyProgress / 100) * (trackLength - 4);
                }

                if (playerProgress >= 100 || enemyProgress >= 100) {
                    finishRace();
                }
            }, 50);
        };

        function finishRace() {
            raceActive = false;
            clearInterval(raceInterval);

            document.getElementById('startRaceBtn').disabled = false;
            document.getElementById('stopRaceBtn').disabled = true;

            const resultDiv = document.getElementById('raceResult');
            const resultTitle = document.getElementById('resultTitle');
            const resultReward = document.getElementById('resultReward');

            const playerFinished = playerProgress >= 100;
            const enemyFinished = enemyProgress >= 100;

            if (playerFinished && !enemyFinished) {
                const reward = 100 + Math.floor(Math.random() * 100);
                addCoins(reward);

                if (Math.random() < 0.25) {
                    showChest();
                }

                resultDiv.className = 'race-result result-win';
                resultTitle.textContent = 'üèÜ –ü–û–ë–ï–î–ê üèÜ';
                resultReward.textContent = `+${reward} –ú–û–ù–ï–¢`;
                document.getElementById('raceStatus').textContent = '–¢–´ –ü–û–ë–ï–î–ò–õ!';
            } 
            else if (!playerFinished && enemyFinished) {
                resultDiv.className = 'race-result result-lose';
                resultTitle.textContent = 'üò¢ –ü–û–†–ê–ñ–ï–ù–ò–ï';
                resultReward.textContent = '';
                document.getElementById('raceStatus').textContent = '–ö–ò–†–Æ–•–ê –ü–û–ë–ï–î–ò–õ';
            }
            else {
                if (playerProgress > enemyProgress) {
                    addCoins(50);
                    if (Math.random() < 0.25) {
                        showChest();
                    }
                    resultDiv.className = 'race-result result-win';
                    resultTitle.textContent = 'ü§ù –§–û–¢–û–§–ò–ù–ò–®';
                    resultReward.textContent = '+50 –ú–û–ù–ï–¢';
                } else {
                    resultDiv.className = 'race-result result-lose';
                    resultTitle.textContent = 'üò¢ –§–û–¢–û–§–ò–ù–ò–®';
                    resultReward.textContent = '';
                }
            }

            resultDiv.style.display = 'block';
        }

        window.stopRace = function() {
            if (!raceActive) return;
            raceActive = false;
            clearInterval(raceInterval);
            document.getElementById('startRaceBtn').disabled = false;
            document.getElementById('stopRaceBtn').disabled = true;
            document.getElementById('raceStatus').textContent = '–ì–û–ù–ö–ê –û–°–¢–ê–ù–û–í–õ–ï–ù–ê';
        };

        window.closeResult = function() {
            document.getElementById('raceResult').style.display = 'none';
        };

        if (window.Telegram?.WebApp) {
            window.Telegram.WebApp.ready();
            window.Telegram.WebApp.expand();
        }

        document.getElementById('coinsDisplay').textContent = getCoins() + ' ü™ô';
    </script>
</body>
                                                       </html>
